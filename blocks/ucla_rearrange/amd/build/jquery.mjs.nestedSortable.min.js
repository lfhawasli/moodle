!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery","jqueryui"],a):a(window.jQuery)}(function(a){"use strict";function b(a,b,c){return a>b&&a<b+c}a.widget("mjs.nestedSortable",a.extend({},a.ui.sortable.prototype,{options:{disableParentChange:!1,doNotClear:!1,expandOnHover:700,isAllowed:function(){return!0},isTree:!1,listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,startCollapsed:!1,tabSize:20,branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf",disabledClass:"mjs-nestedSortable-disabled"},_create:function(){var b,c=this;if(this.element.data("ui-sortable",this.element.data("mjs-nestedSortable")),!this.element.is(this.options.listType))throw b="nestedSortable: Please check that the listType option is set to your actual list type",new Error(b);this.options.isTree&&this.options.expandOnHover&&(this.options.tolerance="intersect"),a.ui.sortable.prototype._create.apply(this,arguments),this.options.isTree&&a(this.items).each(function(){var a=this.item,b=a.hasClass(c.options.collapsedClass),d=a.hasClass(c.options.expandedClass);a.children(c.options.listType).length?(a.addClass(c.options.branchClass),b||d||(c.options.startCollapsed?a.addClass(c.options.collapsedClass):a.addClass(c.options.expandedClass))):a.addClass(c.options.leafClass)})},_destroy:function(){return this.element.removeData("mjs-nestedSortable").removeData("ui-sortable"),a.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=this,t=this.options,u=!1,v=a(document);for(this.position=this._generatePosition(b),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==document&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-b.pageY<t.scrollSensitivity?(u=this.scrollParent.scrollTop()+t.scrollSpeed,this.scrollParent.scrollTop(u)):b.pageY-this.overflowOffset.top<t.scrollSensitivity&&(u=this.scrollParent.scrollTop()-t.scrollSpeed,this.scrollParent.scrollTop(u)),this.overflowOffset.left+this.scrollParent[0].offsetWidth-b.pageX<t.scrollSensitivity?(u=this.scrollParent.scrollLeft()+t.scrollSpeed,this.scrollParent.scrollLeft(u)):b.pageX-this.overflowOffset.left<t.scrollSensitivity&&(u=this.scrollParent.scrollLeft()-t.scrollSpeed,this.scrollParent.scrollLeft(u))):(b.pageY-v.scrollTop()<t.scrollSensitivity?(u=v.scrollTop()-t.scrollSpeed,v.scrollTop(u)):a(window).height()-(b.pageY-v.scrollTop())<t.scrollSensitivity&&(u=v.scrollTop()+t.scrollSpeed,v.scrollTop(u)),b.pageX-v.scrollLeft()<t.scrollSensitivity?(u=v.scrollLeft()-t.scrollSpeed,v.scrollLeft(u)):a(window).width()-(b.pageX-v.scrollLeft())<t.scrollSensitivity&&(u=v.scrollLeft()+t.scrollSpeed,v.scrollLeft(u))),u!==!1&&a.ui.ddmanager&&!t.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b)),this.positionAbs=this._convertPositionTo("absolute"),g=this.placeholder.offset().top,this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),this.hovering=this.hovering?this.hovering:null,this.mouseentered=!!this.mouseentered&&this.mouseentered,function(){var a=this.placeholder.parent().parent();a&&a.closest(".ui-sortable").length&&(h=a)}.call(this),i=this._getLevel(this.placeholder),j=this._getChildLevels(this.helper),m=document.createElement(t.listType),c=this.items.length-1;c>=0;c--)if(d=this.items[c],e=d.item[0],f=this._intersectsWithPointer(d),f&&d.instance===this.currentContainer){if(e.className.indexOf(t.disabledClass)!==-1)if(2===f){if(k=this.items[c+1],k&&k.item.hasClass(t.disabledClass))continue}else if(1===f&&(l=this.items[c-1],l&&l.item.hasClass(t.disabledClass)))continue;if(n=1===f?"next":"prev",!(e===this.currentItem[0]||this.placeholder[n]()[0]===e||a.contains(this.placeholder[0],e)||"semi-dynamic"===this.options.type&&a.contains(this.element[0],e))){if(this.mouseentered||(a(e).mouseenter(),this.mouseentered=!0),t.isTree&&a(e).hasClass(t.collapsedClass)&&t.expandOnHover&&(this.hovering||(a(e).addClass(t.hoveringClass),this.hovering=window.setTimeout(function(){a(e).removeClass(t.collapsedClass).addClass(t.expandedClass),s.refreshPositions(),s._trigger("expand",b,[s._uiHash(),e])},t.expandOnHover))),this.direction=1===f?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(d))break;a(e).mouseleave(),this.mouseentered=!1,a(e).removeClass(t.hoveringClass),this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,!t.protectRoot||this.currentItem[0].parentNode===this.element[0]&&e.parentNode!==this.element[0]?t.protectRoot||this._rearrange(b,d):this.currentItem[0].parentNode!==this.element[0]&&e.parentNode===this.element[0]?(a(e).children(t.listType).length||(e.appendChild(m),t.isTree&&a(e).removeClass(t.leafClass).addClass(t.branchClass+" "+t.expandedClass)),o="down"===this.direction?a(e).prev().children(t.listType):a(e).children(t.listType),void 0!==o[0]&&this._rearrange(b,null,o)):this._rearrange(b,d),this._clearEmpty(e),this._trigger("change",b,this._uiHash());break}}if(function(){var a=this.placeholder.prev();p=a.length?a:null}.call(this),null!=p)for(;"li"!==p[0].nodeName.toLowerCase()||p[0].className.indexOf(t.disabledClass)!==-1||p[0]===this.currentItem[0]||p[0]===this.helper[0];){if(!p[0].previousSibling){p=null;break}p=a(p[0].previousSibling)}if(function(){var a=this.placeholder.next();q=a.length?a:null}.call(this),null!=q)for(;"li"!==q[0].nodeName.toLowerCase()||q[0].className.indexOf(t.disabledClass)!==-1||q[0]===this.currentItem[0]||q[0]===this.helper[0];){if(!q[0].nextSibling){q=null;break}q=a(q[0].nextSibling)}return this.beyondMaxLevels=0,null==h||null!=q||t.protectRoot&&h[0].parentNode==this.element[0]||!(t.rtl&&this.positionAbs.left+this.helper.outerWidth()>h.offset().left+h.outerWidth()||!t.rtl&&this.positionAbs.left<h.offset().left)?null==p||p.hasClass(t.disableNestingClass)||!(p.children(t.listType).length&&p.children(t.listType).is(":visible")||!p.children(t.listType).length)||t.protectRoot&&this.currentItem[0].parentNode===this.element[0]||!(t.rtl&&this.positionAbs.left+this.helper.outerWidth()<p.offset().left+p.outerWidth()-t.tabSize||!t.rtl&&this.positionAbs.left>p.offset().left+t.tabSize)?this._isAllowed(h,i,i+j):(this._isAllowed(p,i,i+j+1),p.children(t.listType).length||(p[0].appendChild(m),t.isTree&&p.removeClass(t.leafClass).addClass(t.branchClass+" "+t.expandedClass)),g&&g<=p.offset().top?p.children(t.listType).prepend(this.placeholder):p.children(t.listType)[0].appendChild(this.placeholder[0]),"undefined"!=typeof h&&this._clearEmpty(h[0]),this._trigger("change",b,this._uiHash())):(h.after(this.placeholder[0]),r=!h.children(t.listItem).children("li:visible:not(.ui-sortable-helper)").length,t.isTree&&r&&h.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass),"undefined"!=typeof h&&this._clearEmpty(h[0]),this._trigger("change",b,this._uiHash())),this._contactContainers(b),a.ui.ddmanager&&a.ui.ddmanager.drag(this,b),this._trigger("sort",b,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(b){this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?a(this.domPosition.prev).after(this.placeholder):a(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",b,this._uiHash())),a("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass),this.mouseentered=!1,this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,this._relocate_event=b,this._pid_current=a(this.domPosition.parent).parent().attr("id"),this._sort_current=this.domPosition.prev?a(this.domPosition.prev).next().index():0,a.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(a){var c=this.options.isTree?.8:.5,d=b(this.positionAbs.top+this.offset.click.top,a.top+a.height*c,a.height),e=b(this.positionAbs.top+this.offset.click.top,a.top-a.height*c,a.height),f=b(this.positionAbs.left+this.offset.click.left,a.left+a.width/2,a.width),g=this._getDragVerticalDirection(),h=this._getDragHorizontalDirection();return this.floating&&h?"right"===h&&f||"left"===h&&!f:g&&("down"===g&&d||"up"===g&&e)},_contactContainers:function(){this.options.protectRoot&&this.currentItem[0].parentNode===this.element[0]||a.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(){var b,c;for(a.ui.sortable.prototype._clear.apply(this,arguments),this._pid_current===this._uiHash().item.parent().parent().attr("id")&&this._sort_current===this._uiHash().item.index()||this._trigger("relocate",this._relocate_event,this._uiHash()),b=this.items.length-1;b>=0;b--)c=this.items[b].item[0],this._clearEmpty(c)},serialize:function(b){var c=a.extend({},this.options,b),d=this._getItemsAsjQuery(c&&c.connected),e=[];return a(d).each(function(){var b=(a(c.item||this).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/),d=(a(c.item||this).parent(c.listType).parent(c.items).attr(c.attribute||"id")||"").match(c.expression||/(.+)[-=_](.+)/);b&&e.push((c.key||b[1])+"["+(c.key&&c.expression?b[1]:b[2])+"]="+(d?c.key&&c.expression?d[1]:d[2]:c.rootID))}),!e.length&&c.key&&e.push(c.key+"="),e.join("&")},toHierarchy:function(b){function c(b){var e,f=(a(b).attr(d.attribute||"id")||"").match(d.expression||/(.+)[-=_](.+)/),g=a(b).data();if(g.nestedSortableItem&&delete g.nestedSortableItem,f)return e={id:f[2]},e=a.extend({},e,g),a(b).children(d.listType).children(d.items).length>0&&(e.children=[],a(b).children(d.listType).children(d.items).each(function(){var a=c(this);e.children.push(a)})),e}var d=a.extend({},this.options,b),e=[];return a(this.element).children(d.items).each(function(){var a=c(this);e.push(a)}),e},toArray:function(b){function c(b,g,h){var i,j,k,l=h+1;if(a(b).children(d.listType).children(d.items).length>0&&(g++,a(b).children(d.listType).children(d.items).each(function(){l=c(a(this),g,l)}),g--),i=(a(b).attr(d.attribute||"id")||"").match(d.expression||/(.+)[-=_](.+)/),g===e?j=d.rootID:(k=a(b).parent(d.listType).parent(d.items).attr(d.attribute||"id").match(d.expression||/(.+)[-=_](.+)/),j=k[2]),i){var m=a(b).children("div").data(),n=a.extend(m,{id:i[2],parent_id:j,depth:g,left:h,right:l});f.push(n)}return h=l+1}var d=a.extend({},this.options,b),e=d.startDepthCount||0,f=[],g=1;return d.excludeRoot||(f.push({item_id:d.rootID,parent_id:null,depth:e,left:g,right:2*(a(d.items,this.element).length+1)}),g++),a(this.element).children(d.items).each(function(){g=c(this,e,g)}),f=f.sort(function(a,b){return a.left-b.left})},_clearEmpty:function(b){function c(b,c,d,e){e&&(c=[d,d=c][0]),a(b).removeClass(c).addClass(d)}var d=this.options,e=a(b).children(d.listType),f=e.has("li").length,g=d.doNotClear||f||d.protectRoot&&a(b)[0]===this.element[0];d.isTree&&c(b,d.branchClass,d.leafClass,g),g||(e.parent().removeClass(d.expandedClass),e.remove())},_getLevel:function(a){var b,c=1;if(this.options.listType)for(b=a.closest(this.options.listType);b&&b.length>0&&!b.is(".ui-sortable");)c++,b=b.parent().closest(this.options.listType);return c},_getChildLevels:function(b,c){var d=this,e=this.options,f=0;return c=c||0,a(b).children(e.listType).children(e.items).each(function(a,b){f=Math.max(d._getChildLevels(b,c+1),f)}),c?f+1:f},_isAllowed:function(a,b,c){var d=this.options,e=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels"),f=this.currentItem.parent().parent(),g=d.disableParentChange&&("undefined"!=typeof a&&!f.is(a)||"undefined"==typeof a&&f.is("li"));g||!d.isAllowed(this.placeholder,a,this.currentItem)?(this.placeholder.addClass(d.errorClass),e<c&&0!==e?this.beyondMaxLevels=c-e:this.beyondMaxLevels=1):e<c&&0!==e?(this.placeholder.addClass(d.errorClass),this.beyondMaxLevels=c-e):(this.placeholder.removeClass(d.errorClass),this.beyondMaxLevels=0)}})),a.mjs.nestedSortable.prototype.options=a.extend({},a.ui.sortable.prototype.options,a.mjs.nestedSortable.prototype.options)});