YUI.add("moodle-local_ucla_support_tools-categoryorganizer",function(e,t){M.local_ucla_support_tools=M.local_ucla_support_tools||{},M.local_ucla_support_tools.categoryorganizer={init:function(){M.local_ucla_support_tools.dragdrop.init(),e.one(".ucla-support-tool-category-button-add").on("click",function(){var t=this.create_category_panel({title:"Create a new category",proceed_label:"Create category"});t.callback=M.local_ucla_support_tools.categoryorganizer.create_category,t.validate=function(){return new e.ArrayList([e.one("#catname-output")])},this.init_color_slider(),t.show()},this),e.one(".ucla-support-tool-category-labels").delegate("click",function(e){e.preventDefault();var t=e.currentTarget.getData("id");this.delete_category(t)},'a[data-action="delete"]',this),e.one(".ucla-support-tool-category-labels").delegate("click",function(e){e.preventDefault();var t=e.currentTarget.getData("id");this.edit_category(t)},'a[data-action="edit"]',this),e.one(".ucla-support-tool-category-list ul").delegate("click",function(e){e.preventDefault();var t=e.currentTarget.getData("id"),n=e.currentTarget.ancestor(".ucla-support-category").getData("id");this.remove_tool({toolid:t,catid:n})},'a[data-action="remove"]',this)},create_category_panel:function(t){var n=M.local_ucla_support_tools.dialog.form_with_inputs(new e.ArrayList([{label:"Name for category",name:"catname",placeholder:"Enter a category name"},{label:"Color",name:"cathex",placeholder:""}])),r='<div class="picker well"><div id="hue-dial"></div><div class="sliders"><div id="sat-slider"><strong>Saturation: <span></span></strong></div><div id="lum-slider"><strong>Luminance: <span></span></strong></div></div><div class="color"></div></div>';n.appendChild(r);var i=M.local_ucla_support_tools.dialog.create({id:"create-category-dialog",title:t.title,body:n.getHTML(),cancel:"Cancel",proceed:t.proceed_label});return i},init_color_slider:function(t){function n(e,t){return Math.floor(Math.random()*(t-e))+e}function h(e){typeof e.h!="undefined"&&o.set("value",+e.h),typeof e.s!="undefined"&&u.set("value",+e.s),typeof e.l!="undefined"&&a.set("value",+e.l)}function p(){var t=o.get("value"),n=u.get("value"),r=a.get("value"),i=e.Color.fromArray([t,n,r],e.Color.TYPES.HSL),s=e.Color.toHex(i);f.set("text",n+"%"),l.set("text",r+"%"),c.setStyle("backgroundColor",s),m(i)}function m(t){d!==v&&d.set("value",e.Color.toHex(t))}function g(t){var n=t.newVal,r=[];e.Color.toArray(n)&&(r=e.Color.toArray(e.Color.toHSL(n)),h({h:r[0],s:r[1],l:r[2]}))}function y(e){v=e.currentTarget}function b(e){v===e.currentTarget&&(v=null)}var r={h:n(0,360),s:n(0,100),l:n(0,100)};if(t){var i=e.Color.convert(t,e.Color.TYPES.HSL),s=e.Color.toArray(i);r={h:parseInt(s[0]),s:parseInt(s[1]),l:parseInt(s[2])}}var o=new e.Dial({min:0,max:360,stepsPerRevolution:360,continuous:!0,centerButtonDiameter:.4,render:"#hue-dial",value:r.h,strings:{label:"Hue",tooltipHandle:"Drag to set value"}}),u=new e.Slider({min:0,max:100,value:r.s,render:"#sat-slider"}),a=new e.Slider({min:0,max:100,value:r.l,render:"#lum-slider"}),f=e.one("#sat-slider span"),l=e.one("#lum-slider span"),c=e.one(".color");o.after("valueChange",function(e){p()}),u.after("thumbMove",function(e){p()}),a.after("thumbMove",function(e){l.set("text",a.get("value")+"%"),p()});var d=e.one("#cathex-output"),v=null;d.on("focus",y),d.on("blur",b),d.on("valueChange",g),p()},create_category:function(){return M.local_ucla_support_tools.categoryorganizer.update_category("createcategory",function(t){var n="<li>"+t.category_html+"</li>";e.one(".ucla-support-tool-category-list ul").appendChild(n),M.local_ucla_support_tools.dragdrop.set_drop_events(e.one('.ucla-support-category[data-id="'+t.id+'"]')),n="<li>"+t.category_label+"</li>",e.one(".ucla-support-tool-category-labels ul").appendChild(n)})},delete_category:function(t){var n=M.local_ucla_support_tools.dialog.create({id:"delete-category-dialog",title:"Delete category",body:"Are you sure you want to delete this category?",cancel:"Cancel",proceed:"Delete category"});n.callback=function(){return e.io(M.cfg.wwwroot+"/local/ucla_support_tools/rest.php",{method:"POST",data:{action:"deletecategory",json:JSON.stringify({id:t}),sesskey:M.cfg.sesskey},on:{success:function(t,n){var r=JSON.parse(n.responseText);r.status&&(e.one('.ucla-support-category[data-id="'+r.id+'"]').ancestor("li").remove(!0),e.one('.ucla-support-tool-category-labels .category-label[data-id="'+r.id+'"]').ancestor("li").remove(!0))}}}),!0},n.show()},edit_category:function(t){e.io(M.cfg.wwwroot+"/local/ucla_support_tools/rest.php",{method:"GET",data:{action:"getcategoryedit",json:JSON.stringify({id:t}),sesskey:M.cfg.sesskey},on:{success:function(n,r){var i=JSON.parse(r.responseText);if(i.status){var s=M.local_ucla_support_tools.categoryorganizer.create_category_panel({title:"Update category",proceed_label:"Save changes"});s.callback=M.local_ucla_support_tools.categoryorganizer.edit_category_callback,s.validate=function(){return new e.ArrayList([e.one("#catname-output")])},s.show(),M.local_ucla_support_tools.categoryorganizer.init_color_slider(i.category.color),e.one("#catname-output").set("value",i.category.name),e.one("#create-category-dialog .message").appendChild('<input type="hidden" id="catid-output" value="'+t+'"/>')}}}})},edit_category_callback:function(){var t=e.one("#catid-output").get("value");return M.local_ucla_support_tools.categoryorganizer.update_category("updatecategory",function(t){var n=e.Node.create(t.html.category),r=e.Node.create(t.html.label);e.one('.ucla-support-category[data-id="'+t.id+'"]').set("innerHTML",n.getHTML()),e.one('.ucla-support-tool-category-labels .category-label[data-id="'+t.id+'"]').set("innerHTML",r.getHTML())},{id:t})},update_category:function(t,n,r){var i=e.one("#catname-output").get("value"),s=e.one("#cathex-output").get("value").replace("#",""),o=e.one("#create-category-dialog .alert");o&&o.remove(!0);var u={name:i,color:s};r&&(u=e.merge(u,r));var a=!1;return e.io(M.cfg.wwwroot+"/local/ucla_support_tools/rest.php"
,{method:"POST",data:{action:t,json:JSON.stringify(u),sesskey:M.cfg.sesskey},on:{success:function(t,r){var i=JSON.parse(r.responseText);i.status?n(i):i.error.msg.indexOf("Error writing to database")!==-1&&e.one("#create-category-dialog h3.title").insert('<div class="alert alert-warning" role="alert"><strong>Unable to create category!</strong> Perhaps you already have a category with the same name?</div>',"after"),a=i.status}},sync:!0}),a},add_tool:function(t){e.io(M.cfg.wwwroot+"/local/ucla_support_tools/rest.php",{method:"POST",data:{action:"addtooltocategory",sesskey:M.cfg.sesskey,json:JSON.stringify(t)}})},remove_tool:function(t){return e.io(M.cfg.wwwroot+"/local/ucla_support_tools/rest.php",{method:"POST",data:{action:"removetoolfromcategory",sesskey:M.cfg.sesskey,json:JSON.stringify(t)},on:{success:function(t,n){var r=JSON.parse(n.responseText);r.status&&e.one('.ucla-support-category[data-id="'+r.catid+'"] .ucla-support-tool[data-id="'+r.toolid+'"]').ancestor("li").remove(!0)}}}),!0}}},"@VERSION@",{requires:["base","node","moodle-local_ucla_support_tools-dialog","dial","slider","event-valuechange","color","io","arraylist","moodle-local_ucla_support_tools-dragdrop","moodle-local_ucla_support_tools-filter","node-event-simulate"]});
